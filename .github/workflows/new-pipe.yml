name: Terraform Lake Formation Pipeline

on:
  push:
    branches: [ "main" ]

permissions:
  id-token: write
  contents: read

concurrency:
  group: terraform-${{ github.ref }}
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: eu-central-1

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.6

      - name: Terraform Init
        working-directory: infra
        run: terraform init -reconfigure

      # -------------------------
      # PHASE 1: Infra (NO LF governance)
      # -------------------------
      - name: Terraform Apply (infra only - governance OFF)
        working-directory: infra
        run: |
          terraform apply -auto-approve \
            -var-file=terraform.tfvars \
            -var="enable_lf_table_governance=false"

      # -------------------------
      # PHASE 2: Run Glue crawler
      # -------------------------
      - name: Read crawler name from tfvars
        id: crawler
        run: |
          # Extract glue_crawler_name = "...." from infra/terraform.tfvars
          CRAWLER=$(grep -E '^\s*glue_crawler_name\s*=' infra/terraform.tfvars | head -n1 | cut -d'=' -f2- | tr -d ' "')
          echo "crawler_name=$CRAWLER" >> $GITHUB_OUTPUT
          echo "Crawler name: $CRAWLER"

      - name: Start Glue crawler
        run: |
          aws glue start-crawler --name "${{ steps.crawler.outputs.crawler_name }}" --region eu-central-1

      - name: Wait for Glue crawler to finish
        run: |
          echo "Waiting for crawler to finish..."
          for i in {1..60}; do
            STATE=$(aws glue get-crawler --name "${{ steps.crawler.outputs.crawler_name }}" --region eu-central-1 --query 'Crawler.State' --output text)
            echo "Crawler state: $STATE"
            if [ "$STATE" = "READY" ]; then
              echo "Crawler finished."
              exit 0
            fi
            sleep 10
          done
          echo "Crawler did not finish in time."
          exit 1

      # -------------------------
      # PHASE 3: LF Governance (apply tags + permissions)
      # -------------------------
      - name: Terraform Apply (LF tags + permissions - governance ON)
        working-directory: infra
        run: |
          terraform apply -auto-approve \
            -var-file=terraform.tfvars \
            -var="enable_lf_table_governance=true"
